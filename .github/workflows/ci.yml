name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: read-all

env:
  REGISTRY_NAME: ${{ secrets.ACR_NAME }}.azurecr.io
  TAG: gha${{ github.run_number }}

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.0.0
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'

      - name: Install ruff
        # To update: pip download --no-deps ruff==<version> && pip hash ruff-*.whl
        run: |
          printf 'ruff==0.9.2 \
              --hash=sha256:80605a039ba1454d002b32139e4970becf84b5fee3a3c3bf1c2af6f61a784347 \
              --hash=sha256:b9aab82bb20afd5f596527045c01e6ae25a718ff1784cb92947bff1f83068b00 \
              --hash=sha256:fbd337bac1cfa96be615f6efcd4bc4d077edbc127ef30e2b8ba2a27e18c054d4 \
              --hash=sha256:82b35259b0cbf8daa22a498018e300b9bb0174c2bbb7bcba593935158a78054d \
              --hash=sha256:8b6a9701d1e371bf41dca22015c3f89769da7576884d2add7317ec1ec8cb9c3c \
              --hash=sha256:9cc53e68b3c5ae41e8faf83a3b89f4a5d7b2cb666dff4b366bb86ed2a85b481f \
              --hash=sha256:3292c5a22ea9a5f9a185e2d131dc7f98f8534a32fb6d2ee7b9944569239c648d \
              --hash=sha256:8efd9da7a1ee314b910da155ca7e8953094a7c10d0c0a39bfde3fcfd2a015684 \
              --hash=sha256:1a605fdcf6e8b2d39f9436d343d1f0ff70c365a1e681546de0104bef81ce88df \
              --hash=sha256:c547f7f256aa366834829a08375c297fa63386cbe5f1459efaf174086b564247 \
              --hash=sha256:d18bba3d3353ed916e882521bc3e0af403949dbada344c20c16ea78f47af965e \
              --hash=sha256:b338edc4610142355ccf6b87bd356729b62bf1bc152a2fad5b0c7dc04af77bfe \
              --hash=sha256:492a5e44ad9b22a0ea98cf72e40305cbdaf27fac0d927f8bc9e1df316dcc96eb \
              --hash=sha256:af1e9e9fe7b1f767264d26b1075ac4ad831c7db976911fa362d09b2d0356426a \
              --hash=sha256:71cbe22e178c5da20e1514e1e01029c73dc09288a8028a5d3446e6bba87a5145 \
              --hash=sha256:c5e1d6abc798419cf46eed03f54f2e0c3adb1ad4b801119dedf23fcaf69b55b5 \
              --hash=sha256:a1b63fa24149918f8b37cef2ee6fff81f24f0d74b6f0bdc37bc3e1f2143e41c6\n' \
            | pip install --no-deps --require-hashes -r /dev/stdin

      - name: Run ruff check
        run: ruff check

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-slim
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.0.0
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@c74b580d73376b7750d3d2a50bfb8adc2c937507 # v4.5.0
        with:
          fail-on-severity: low
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause
          comment-summary-in-pr: on-failure

  test:
    name: Test ${{ matrix.component.name }} (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
        component: 
          - name: 'Analyzer'
            path: 'presidio-analyzer'
            extras: '--all-extras'
            spacy-models: 'en_core_web_lg en_core_web_sm'
          - name: 'Anonymizer'
            path: 'presidio-anonymizer'
            extras: ''
            spacy-models: ''
          - name: 'Image Redactor'
            path: 'presidio-image-redactor'
            extras: ''
            spacy-models: 'en_core_web_lg'
          - name: 'CLI'
            path: 'presidio-cli'
            extras: ''
            spacy-models: ''
          - name: 'Structured'
            path: 'presidio-structured'
            extras: ''
            spacy-models: ''
    env:
      POETRY_CACHE_DIR: /mnt/poetry_cache
      COVERAGE_THRESHOLD: 90
      PRIMARY_PYTHON: '3.13'
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.0.0
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: ${{ matrix.component.path }}/pyproject.toml

      - name: Install Poetry
        run: |
          printf 'poetry==2.3.2 --hash=sha256:4b64412c61b4de2c7268ffebbde7d564b655a37d29c2cd82bf1b52f15c8066b4\n' \
            | python -m pip install --no-deps --require-hashes -r /dev/stdin

      - name: Setup Poetry Cache Directory
        run: |
          sudo mkdir -p $POETRY_CACHE_DIR
          sudo chown -R runner $POETRY_CACHE_DIR    

      - name: Install system dependencies for Image Redactor
        if: matrix.component.name == 'Image Redactor'
        run: |
          sudo apt-get update
          sudo apt-get install tesseract-ocr -y

      - name: Install dependencies
        working-directory: ${{ matrix.component.path }}
        run: |
          poetry install ${{ matrix.component.extras }}

      - name: Install presidio-analyzer for Image Redactor
        if: matrix.component.name == 'Image Redactor'
        working-directory: ${{ matrix.component.path }}
        run: |
          poetry run pip install -e ../presidio-analyzer/.

      - name: Download spaCy models
        if: matrix.component.spacy-models != ''
        working-directory: ${{ matrix.component.path }}
        run: |
          for model in ${{ matrix.component.spacy-models }}; do
            poetry run python -m spacy download $model
          done

      - name: Run tests with coverage
        working-directory: ${{ matrix.component.path }}
        run: |
          PACKAGE_NAME=$(echo "${{ matrix.component.path }}" | sed 's/-/_/g')
          poetry run pytest --cov=$PACKAGE_NAME --cov-report=xml:coverage.xml --cov-report=term --cov-report=html -vv --tb=short
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Checking PR difference coverage (>= ${{ env.COVERAGE_THRESHOLD }}%) with diff-cover..."
            poetry run diff-cover coverage.xml \
              --compare-branch=origin/${{ github.base_ref }} \
              --fail-under=${{ env.COVERAGE_THRESHOLD }} \
              --show-uncovered
          fi

      - name: Comment PR with Coverage
        if: matrix.python-version == env.PRIMARY_PYTHON
        uses: py-cov-action/python-coverage-comment-action@7188638f871f721a365d644f505d1ff3df20d683 # v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 85
          MINIMUM_ORANGE: 70
          COVERAGE_DATA_BRANCH: coverage-data
          SUBPROJECT_ID: ${{ matrix.component.path }}
          COVERAGE_PATH: ${{ matrix.component.path }}

      - name: Build wheel package
        working-directory: ${{ matrix.component.path }}
        run: |
          printf 'build==1.2.2.post1 --hash=sha256:1d61c0887fa860c01971625baae8bdd338e517b836a2f70dd1f7aa3a6b2fc5b5\n' \
            | pip install --no-deps --require-hashes -r /dev/stdin
          python -m build --wheel

  build-platform-images:
    name: Build ${{ matrix.image }} (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    needs: [lint]
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        include:
          - image: presidio-anonymizer
            platform: linux/amd64
            runner: ubuntu-latest
          - image: presidio-analyzer
            platform: linux/amd64
            runner: ubuntu-latest
          - image: presidio-image-redactor
            platform: linux/amd64
            runner: ubuntu-latest
          - image: presidio-anonymizer
            platform: linux/arm64
            runner: ubuntu-24.04-arm
          - image: presidio-analyzer
            platform: linux/arm64
            runner: ubuntu-24.04-arm
          - image: presidio-image-redactor
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.0.0
        with:
          persist-credentials: false

      - name: Azure Login using OIDC
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: Build and Push ${{ matrix.image }} for ${{ matrix.platform }}
        run: |
          # Create platform-specific tag
          PLATFORM_TAG=$(echo "${{ matrix.platform }}" | sed 's/\//-/g')
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --push \
            --tag ${{ env.REGISTRY_NAME }}/${{ matrix.image }}:${{ env.TAG }}-${PLATFORM_TAG} \
            --cache-from type=registry,ref=${{ env.REGISTRY_NAME }}/public/${{ matrix.image }}:latest \
            --cache-to type=inline \
            --attest type=sbom \
            --attest type=provenance,mode=max \
            ./${{ matrix.image }}
        env:
          REGISTRY_NAME: ${{ env.REGISTRY_NAME }}
          TAG: ${{ env.TAG }}

  create-manifests:
    name: Create Multi-Platform Manifests
    runs-on: ubuntu-latest
    needs: build-platform-images
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Azure Login using OIDC
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: Create all multi-platform manifests
        run: |
          IMAGES=("presidio-anonymizer" "presidio-analyzer" "presidio-image-redactor")
          
          for image in "${IMAGES[@]}"; do
            echo "Creating manifest for $image"
            docker buildx imagetools create \
              --tag ${{ env.REGISTRY_NAME }}/${image}:${{ env.TAG }} \
              ${{ env.REGISTRY_NAME }}/${image}:${{ env.TAG }}-linux-amd64 \
              ${{ env.REGISTRY_NAME }}/${image}:${{ env.TAG }}-linux-arm64
          done
        env:
          REGISTRY_NAME: ${{ env.REGISTRY_NAME }}
          TAG: ${{ env.TAG }}

  e2e-tests:
    name: E2E Tests (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    needs: create-manifests
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.0.0
        with:
          persist-credentials: false

      - name: Azure Login using OIDC
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Pull Presidio images from ACR
        run: |
          export DOCKER_DEFAULT_PLATFORM=${{ matrix.platform }}
          docker compose -f docker-compose.yml pull
        env:
          REGISTRY_NAME: ${{ env.REGISTRY_NAME }}
          TAG: :${{ env.TAG }}

      - name: Start Presidio cluster
        run: |
          export DOCKER_DEFAULT_PLATFORM=${{ matrix.platform }}
          docker compose -f docker-compose.yml up -d
        env:
          REGISTRY_NAME: ${{ env.REGISTRY_NAME }}
          TAG: :${{ env.TAG }}

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.10'

      - name: Cache E2E dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v5.0.0
        with:
          path: |
            ~/.cache/pip
            e2e-tests/env
          key: ${{ runner.os }}-${{ matrix.platform }}-e2e-${{ hashFiles('e2e-tests/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.platform }}-e2e-

      - name: Install E2E test dependencies
        working-directory: e2e-tests
        run: |
          python -m venv env
          source env/bin/activate
          pip install -r requirements.txt
          python -m spacy download en_core_web_lg

      - name: Wait for services to be ready
        run: sleep 60

      - name: Download Ollama model for Ollama LangExtract recognizer tests
        run: |
          docker exec $(docker ps -qf "name=ollama") ollama pull qwen2.5:1.5b
          docker exec $(docker ps -qf "name=ollama") ollama run qwen2.5:1.5b

      - name: Run E2E tests
        working-directory: e2e-tests
        run: |
          source env/bin/activate
          pytest -vv --tb=short

      - name: Capture Docker logs on failure (${{ matrix.platform }})
        if: failure()
        run: |
          echo "Capturing Docker logs for platform: ${{ matrix.platform }}"
          docker compose -f docker-compose.yml logs

      - name: Stop Docker containers
        if: always()
        run: |
          docker compose -f docker-compose.yml down

  # Local build and test jobs for external contributors (no secrets required) 
  local-build-and-test:
    name: Local Build and E2E Tests (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    needs: [lint]
    if: github.ref != 'refs/heads/main'
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.0.0
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: Build Presidio images locally
        run: |
          # Build all images locally without pushing
          docker compose -f docker-compose.yml build
        env:
          REGISTRY_NAME: 'mcr.microsoft.com'
          IMAGE_PREFIX: ''
          TAG: gha${{ github.run_number }}

      - name: Start Presidio cluster locally
        run: |
          docker compose -f docker-compose.yml up -d
        env:
          REGISTRY_NAME: 'mcr.microsoft.com'
          IMAGE_PREFIX: ''
          TAG: gha${{ github.run_number }}

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.10'

      - name: Cache E2E dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v5.0.0
        with:
          path: |
            ~/.cache/pip
            e2e-tests/env
          key: ${{ runner.os }}-${{ matrix.platform }}-local-e2e-${{ hashFiles('e2e-tests/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.platform }}-local-e2e-

      - name: Install E2E test dependencies
        working-directory: e2e-tests
        run: |
          python -m venv env
          source env/bin/activate
          pip install -r requirements.txt
          python -m spacy download en_core_web_lg

      - name: Wait for services to be ready
        run: sleep 60

      - name: Download Ollama model for Ollama LangExtract recognizer tests
        run: |
          docker exec $(docker ps -qf "name=ollama") ollama pull qwen2.5:1.5b
          docker exec $(docker ps -qf "name=ollama") ollama run qwen2.5:1.5b

      - name: Run E2E tests
        working-directory: e2e-tests
        run: |
          source env/bin/activate
          pytest -vv --tb=short

      - name: Capture Docker logs on failure
        if: failure()
        run: |
          echo "Capturing Docker logs for local build"
          docker compose -f docker-compose.yml logs

      - name: Stop Docker containers
        if: always()
        run: |
          docker compose -f docker-compose.yml down
