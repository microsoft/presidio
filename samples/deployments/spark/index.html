
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="PII anonymization for text and images.">
      
      
        <meta name="author" content="Microsoft">
      
      
        <link rel="canonical" href="https://microsoft.github.io/presidio/samples/deployments/spark/">
      
      <link rel="icon" href="../../../assets/ms_icon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.11">
    
    
      
        <title>Anonymize PII using Presidio on Spark - Microsoft Presidio</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8c5ef100.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.9647289d.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "5pd40fk720");
</script>

    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#anonymize-pii-using-presidio-on-spark" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Microsoft Presidio" class="md-header__button md-logo" aria-label="Microsoft Presidio" data-md-component="logo">
      
  <img src="../../../assets/ms_icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Microsoft Presidio
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Anonymize PII using Presidio on Spark
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/presidio/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Microsoft Presidio" class="md-nav__button md-logo" aria-label="Microsoft Presidio" data-md-component="logo">
      
  <img src="../../../assets/ms_icon.png" alt="logo">

    </a>
    Microsoft Presidio
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/presidio/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../getting_started/" class="md-nav__link">
        Quickstart
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Step by step tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Step by step tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Step by step tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/00_getting_started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/01_deny_list/" class="md-nav__link">
        Deny-list recognizers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/02_regex/" class="md-nav__link">
        Regex recognizers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/03_rule_based/" class="md-nav__link">
        Rule-based recognizers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/05_languages/" class="md-nav__link">
        Additional models/languages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/04_external_services/" class="md-nav__link">
        External services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/06_context/" class="md-nav__link">
        Context enhancement
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/07_decision_process/" class="md-nav__link">
        Decision process
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/08_no_code/" class="md-nav__link">
        No-code recognizers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/09_ad_hoc/" class="md-nav__link">
        Ad-hoc recognizers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/10_simple_anonymization/" class="md-nav__link">
        Simple anonymization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/11_custom_anonymization/" class="md-nav__link">
        Custom anonymization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/12_encryption/" class="md-nav__link">
        Encryption/Decryption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/13_allow_list/" class="md-nav__link">
        Allow-lists
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Docs" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Handling text
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Handling text" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Handling text
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../text_anonymization/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" type="checkbox" id="__nav_4_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_2">
          Presidio Analyzer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Presidio Analyzer" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_2">
          <span class="md-nav__icon md-icon"></span>
          Presidio Analyzer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyzer/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2_2" type="checkbox" id="__nav_4_2_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_2_2">
          Developing PII recognizers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developing PII recognizers" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_2_2_2">
          <span class="md-nav__icon md-icon"></span>
          Developing PII recognizers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyzer/adding_recognizers/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyzer/developing_recognizers/" class="md-nav__link">
        Best practices in developing recognizers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyzer/languages/" class="md-nav__link">
        Multi-language support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyzer/customizing_nlp_models/" class="md-nav__link">
        Customizing the NLP model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyzer/decision_process/" class="md-nav__link">
        Tracing the decision process
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_3" type="checkbox" id="__nav_4_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_3">
          Presidio Anonymizer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Presidio Anonymizer" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_3">
          <span class="md-nav__icon md-icon"></span>
          Presidio Anonymizer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../anonymizer/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../anonymizer/adding_operators/" class="md-nav__link">
        Developing PII operators
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../image-redactor/" class="md-nav__link">
        Handling images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../supported_entities/" class="md-nav__link">
        Supported entities
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Development and design
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Development and design" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Development and design
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/" class="md-nav__link">
        Design
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/" class="md-nav__link">
        Setting up a development environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../build_release/" class="md-nav__link">
        Build and release process
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../presidio_V2/" class="md-nav__link">
        Changes from V1 to V2
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5_5" type="checkbox" id="__nav_4_5_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_5_5">
          Python API reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python API reference" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_5_5">
          <span class="md-nav__icon md-icon"></span>
          Python API reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/analyzer_python/" class="md-nav__link">
        Presidio Analyzer Python API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/anonymizer_python/" class="md-nav__link">
        Presidio Anonymizer Python API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/image_redactor_python/" class="md-nav__link">
        Presidio Image Redactor Python API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://microsoft.github.io/presidio/api-docs/api-docs.html" target="_blank" class="md-nav__link">
        REST API reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Samples
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../community/" class="md-nav__link">
        Community
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-basics-of-working-with-presidio-in-spark" class="md-nav__link">
    The basics of working with Presidio in Spark
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
    <nav class="md-nav" aria-label="Pre-requisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-infrastructure" class="md-nav__link">
    Deploy Infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-databricks" class="md-nav__link">
    Setup Databricks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-an-existing-cluster" class="md-nav__link">
    Configure an existing cluster
  </a>
  
    <nav class="md-nav" aria-label="Configure an existing cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-secret-scope-and-secrets-for-storage-account" class="md-nav__link">
    Set up secret scope and secrets for storage account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-or-update-cluster-init-scripts" class="md-nav__link">
    Upload or update cluster init scripts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-presidio-notebooks" class="md-nav__link">
    Upload presidio notebooks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-cluster-environment" class="md-nav__link">
    Update cluster environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mount-the-storage-container" class="md-nav__link">
    Mount the storage container
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-sample" class="md-nav__link">
    Running the sample
  </a>
  
    <nav class="md-nav" aria-label="Running the sample">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-presidio-transformation-notebook" class="md-nav__link">
    Configure Presidio transformation notebook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-notebook" class="md-nav__link">
    Run the notebook
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              



                


<h1 id="anonymize-pii-using-presidio-on-spark">Anonymize PII using Presidio on Spark</h1>
<p>You can leverages presidio to perform data anonymization as part of spark notebooks.</p>
<p>The following sample uses <a href="https://docs.microsoft.com/en-us/azure/databricks/">Azure Databricks</a> and simple text files hosted on <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/">Azure Blob Storage</a>. However, it can easily change to fit any other scenario which requires PII analysis or anonymization as part of spark jobs.</p>
<p><strong>Note</strong> that this code works for Databricks runtime 8.1 (spark 3.1.1) and the libraries described <a href="https://docs.microsoft.com/en-us/azure/databricks/release-notes/runtime/8.1">here</a>.</p>
<h2 id="the-basics-of-working-with-presidio-in-spark">The basics of working with Presidio in Spark</h2>
<p>A typical use case of Presidio in Spark is transforming a text column in a data frame, by anonymizing its content. The following code sample, a part of <a href="notebooks/01_transform_presidio.py">transform presidio notebook</a>, is the basis of the e2e sample which uses Azure Databricks as the Spark environment.</p>
<div class="highlight"><pre><span></span><code><span class="n">anonymized_column</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span> <span class="c1"># name of column to anonymize</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">AnalyzerEngine</span><span class="p">()</span>
<span class="n">anonymizer</span> <span class="o">=</span> <span class="n">AnonymizerEngine</span><span class="p">()</span>

<span class="c1"># broadcast the engines to the cluster nodes</span>
<span class="n">broadcasted_analyzer</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">analyzer</span><span class="p">)</span>
<span class="n">broadcasted_anonymizer</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">anonymizer</span><span class="p">)</span>

<span class="c1"># define a pandas UDF function and a series function over it.</span>
<span class="k">def</span> <span class="nf">anonymize_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">broadcasted_analyzer</span><span class="o">.</span><span class="n">value</span>
    <span class="n">anonymizer</span> <span class="o">=</span> <span class="n">broadcasted_anonymizer</span><span class="o">.</span><span class="n">value</span>
    <span class="n">analyzer_results</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">)</span>
    <span class="n">anonymized_results</span> <span class="o">=</span> <span class="n">anonymizer</span><span class="o">.</span><span class="n">anonymize</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
        <span class="n">analyzer_results</span><span class="o">=</span><span class="n">analyzer_results</span><span class="p">,</span>
        <span class="n">operators</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;DEFAULT&quot;</span><span class="p">:</span> <span class="n">OperatorConfig</span><span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;new_value&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ANONYMIZED&gt;&quot;</span><span class="p">})</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">anonymized_results</span><span class="o">.</span><span class="n">text</span>


<span class="k">def</span> <span class="nf">anonymize_series</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">anonymize_text</span><span class="p">)</span>


<span class="c1"># define a the function as pandas UDF</span>
<span class="n">anonymize</span> <span class="o">=</span> <span class="n">pandas_udf</span><span class="p">(</span><span class="n">anonymize_series</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">StringType</span><span class="p">())</span>

<span class="c1"># apply the udf</span>
<span class="n">anonymized_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
    <span class="n">anonymized_column</span><span class="p">,</span> <span class="n">anonymize</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">anonymized_column</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>If you do not have an instance of Azure Databricks, follow through with the following steps to provision and setup the required infrastrucutre.</p>
<p>If you do have a Databricks workspace and a cluster you wish to configure to run Presidio, jump over to the <a href="#Configure-an-existing-cluster">Configure an existing cluster</a> section.</p>
<h3 id="deploy-infrastructure">Deploy Infrastructure</h3>
<p>Provision the Azure resources by running the following script.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">RESOURCE_GROUP</span><span class="o">=[</span>resource group name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">STORAGE_ACCOUNT_NAME</span><span class="o">=[</span>storage account name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">STORAGE_CONTAINER_NAME</span><span class="o">=[</span>blob container name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">DATABRICKS_WORKSPACE_NAME</span><span class="o">=[</span>databricks workspace name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">DATABRICKS_SKU</span><span class="o">=[</span>basic/standard/premium<span class="o">]</span>
<span class="nb">export</span> <span class="nv">LOCATION</span><span class="o">=[</span>location<span class="o">]</span>

<span class="c1"># Create the resource group</span>
az group create --name <span class="nv">$RESOURCE_GROUP</span> --location <span class="nv">$LOCATION</span>

<span class="c1"># Use ARM template to build the resources and get back the workspace URL</span>
<span class="nv">deployment_response</span><span class="o">=</span><span class="k">$(</span>az deployment group create -g <span class="nv">$RESOURCE_GROUP</span> --template-file ./docs/samples/deployments/spark/arm-template/databricks.json  --parameters <span class="nv">location</span><span class="o">=</span><span class="nv">$LOCATION</span> <span class="nv">workspaceName</span><span class="o">=</span><span class="nv">$DATABRICKS_WORKSPACE_NAME</span> <span class="nv">storageAccountName</span><span class="o">=</span><span class="nv">$STORAGE_ACCOUNT_NAME</span> <span class="nv">containerName</span><span class="o">=</span><span class="nv">$STORAGE_CONTAINER_NAME</span><span class="k">)</span>

<span class="nb">export</span> <span class="nv">DATABRICKS_WORKSPACE_URL</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$deployment_response</span> <span class="p">|</span> jq -r <span class="s2">&quot;.properties.outputs.workspaceUrl.value&quot;</span><span class="k">)</span>
<span class="nb">export</span> <span class="nv">DATABRICKS_WORKSPACE_ID</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$deployment_response</span> <span class="p">|</span> jq -r <span class="s2">&quot;.properties.outputs.workspaceId.value&quot;</span><span class="k">)</span>
</code></pre></div>
<h3 id="setup-databricks">Setup Databricks</h3>
<p>The following script will setup a new cluster in the databricks workspace and prepare it to run presidio anonymization jobs.
Once finished, the script will output an access key which you can use when working with databricks cli.</p>
<div class="highlight"><pre><span></span><code>sh ./scripts/configure_databricks.sh
</code></pre></div>
<h3 id="configure-an-existing-cluster">Configure an existing cluster</h3>
<p>Only follow through with the steps in this section if you have an existing databricks workspace and clsuter you wish to configure to run presidio. If you've followed through with the "Deploy Infrastructure" and "Setup Databricks" sections you do not have to run the script in this section.</p>
<h4 id="set-up-secret-scope-and-secrets-for-storage-account">Set up secret scope and secrets for storage account</h4>
<p>Add an Azure Storage account key to secret scope.</p>
<div class="highlight"><pre><span></span><code><span class="nv">STORAGE_PRIMARY_KEY</span><span class="o">=[</span>Primary key of storage account<span class="o">]</span>

databricks secrets create-scope --scope storage_scope --initial-manage-principal users
databricks secrets put --scope storage_scope --key storage_account_access_key --string-value <span class="s2">&quot;</span><span class="nv">$STORAGE_PRIMARY_KEY</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="upload-or-update-cluster-init-scripts">Upload or update cluster init scripts</h4>
<p>Presidio libraries are loaded to the cluster on init.
Upload the cluster setup script or add its content to the existing cluster's init script.</p>
<div class="highlight"><pre><span></span><code>databricks fs cp <span class="s2">&quot;./setup/startup.sh&quot;</span> <span class="s2">&quot;dbfs:/FileStore/dependencies/startup.sh&quot;</span>
</code></pre></div>
<p>Setup the cluster to run the <a href="https://docs.microsoft.com/en-us/azure/databricks/clusters/configure#init-scripts">init script</a>.</p>
<h4 id="upload-presidio-notebooks">Upload presidio notebooks</h4>
<div class="highlight"><pre><span></span><code>databricks workspace import_dir <span class="s2">&quot;./notebooks&quot;</span> <span class="s2">&quot;/notebooks&quot;</span> --overwrite
</code></pre></div>
<h4 id="update-cluster-environment">Update cluster environment</h4>
<p>Add the following <a href="https://docs.microsoft.com/en-us/azure/databricks/clusters/configure#environment-variables">environment variables</a> to your databricks cluster:</p>
<div class="highlight"><pre><span></span><code><span class="s2">&quot;STORAGE_MOUNT_NAME&quot;</span>: <span class="s2">&quot;/mnt/files&quot;</span>
<span class="s2">&quot;STORAGE_CONTAINER_NAME&quot;</span>: <span class="o">[</span>Blob container name<span class="o">]</span>
<span class="s2">&quot;STORAGE_ACCOUNT_NAME&quot;</span>: <span class="o">[</span>Storage account name<span class="o">]</span>
</code></pre></div>
<h4 id="mount-the-storage-container">Mount the storage container</h4>
<p>Run the notebook 00_setup to mount the storage account to databricks.</p>
<h2 id="running-the-sample">Running the sample</h2>
<h3 id="configure-presidio-transformation-notebook">Configure Presidio transformation notebook</h3>
<p>From Databricks workspace, under notebooks folder, open the provided 01_transform_presidio notebook and attach it to the cluster preisidio_cluster.
Run the first code-cell and note the following parameters on the top end of the notebook (notebook widgets) and set them accordingly</p>
<ul>
<li>Input File Format - text (selected).</li>
<li>Input path - a folder on the container where input files are found.</li>
<li>Output Folder - a folder on the container where output files will be written to.</li>
<li>Column to Anonymize - value (selected).</li>
</ul>
<h3 id="run-the-notebook">Run the notebook</h3>
<p>Upload a text file to the blob storage input folder, using any preferd method (<a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal">Azure Portal</a>, <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-storage-explorer">Azure Storage Explorer</a>, <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-cli">Azure CLI</a>).</p>
<div class="highlight"><pre><span></span><code>az storage blob upload --account-name <span class="nv">$STORAGE_ACCOUNT_NAME</span>  --container <span class="nv">$STORAGE_CONTAINER_NAME</span> --file ./<span class="o">[</span>file name<span class="o">]</span> --name input/<span class="o">[</span>file name<span class="o">]</span>
</code></pre></div>
<p>Run the notebook cells, the output should be csv files which contain two columns, the original file name, and the anonymized content of that file.</p>

              

            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/microsoft/presidio" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://hub.docker.com/_/microsoft-presidio" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    <a href="mailto:presidio@microsoft.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M464 64c26.5 0 48 21.49 48 48 0 15.1-7.1 29.3-19.2 38.4L275.2 313.6a32.1 32.1 0 0 1-38.4 0L19.2 150.4C7.113 141.3 0 127.1 0 112c0-26.51 21.49-48 48-48h416zM217.6 339.2a63.9 63.9 0 0 0 76.8 0L512 176v208c0 35.3-28.7 64-64 64H64c-35.35 0-64-28.7-64-64V176l217.6 163.2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant"], "search": "../../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.748e2769.min.js"></script>
      
    
  </body>
</html>